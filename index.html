<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº«å­˜ç®¡å®¶ V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translate(0, 20px); } /* ä¿®æ­£å‹•ç•«ï¼šåªç§»å‹•Yè»¸ï¼Œä¸å½±éŸ¿Xè»¸ç½®ä¸­ */
            to { opacity: 1; transform: translate(0, 0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        input, select, button { outline: none; }
        
        /* æ»¿ç‰ˆé®ç½© (é€šç”¨) */
        .full-overlay { 
            position: fixed; inset: 0; background: #f3f4f6; z-index: 9999; 
            display: flex; justify-content: center; align-items: center; 
            flex-direction: column; padding: 20px;
        }

        /* Modal å„ªåŒ–ï¼šé‡å° iPhone å¼·åŠ›ç½®ä¸­ä¿®æ­£ */
        .modal-overlay { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100vw; /* å¼·åˆ¶è¦–çª—å¯¬åº¦ */
            height: 100vh; /* å¼·åˆ¶è¦–çª—é«˜åº¦ */
            background-color: rgba(0,0,0,0.5); 
            z-index: 9999; /* ç¢ºä¿æœ€ä¸Šå±¤ */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem;
        }
        .modal-content { 
            background: white; 
            width: 90%; 
            max-width: 24rem; 
            margin: auto; /* é—œéµï¼šè‡ªå‹•é‚Šè·ç¢ºä¿ç½®ä¸­ */
            border-radius: 0.75rem; 
            display: flex; flex-direction: column; 
            max-height: 80vh; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            transform-origin: center; /* ç¢ºä¿å‹•ç•«å¾ä¸­å¿ƒé–‹å§‹ */
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans text-gray-800 overflow-hidden">

    <!-- 1. ğŸ” ç™»å…¥ç•«é¢ -->
    <div id="login-screen" class="full-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
            <div class="mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto text-2xl">
                    <i class="fas fa-lock"></i>
                </div>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">è«‹è¼¸å…¥å¯†ç¢¼</h2>
            <input type="tel" id="login-pass" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-center text-xl font-bold tracking-widest mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="â€¢â€¢â€¢â€¢" maxlength="8">
            <button onclick="app.checkLogin()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">è§£é–</button>
            <p id="login-error" class="text-red-500 text-xs mt-3 hidden">å¯†ç¢¼éŒ¯èª¤</p>
        </div>
    </div>

    <!-- 2. è®€å–ç•«é¢ -->
    <div id="loading-screen" class="full-overlay hidden">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600"></i>
        <p class="text-gray-500 text-sm mt-4">è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>

    <!-- 3. ä¸»ä»‹é¢ -->
    
    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <div class="bg-white p-3 shadow-sm z-20 flex-none">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-extrabold text-gray-800 tracking-tight flex items-center gap-2">
                <i class="fas fa-cloud text-blue-500"></i> åº«å­˜ç®¡å®¶
            </h1>
            <div class="flex gap-2">
                <div id="connection-status" class="text-xs text-green-500 font-bold flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> é€£ç·šä¸­
                </div>
            </div>
        </div>
    </div>

    <!-- æµ®å‹•é€šçŸ¥å€ -->
    <div id="notification-area" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none w-full max-w-xs flex flex-col items-center"></div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div id="main-content" class="flex-1 overflow-y-auto p-4 pb-24 relative max-w-2xl mx-auto w-full hidden"></div>

    <!-- åº•éƒ¨å°èˆªæ¬„ -->
    <div class="bg-white border-t border-gray-200 px-2 py-2 flex justify-between items-center fixed bottom-0 w-full left-0 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] text-xs">
        <button onclick="app.switchTab('shopping')" id="nav-shopping" class="nav-btn flex flex-col items-center gap-1 py-2 w-1/4 text-blue-600 relative">
            <div class="relative">
                <i class="fas fa-shopping-cart text-xl mb-0.5"></i>
                <span id="badge-count" class="hidden absolute -top-1 -right-2 bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-white">0</span>
            </div>
            <span>å¾…è²·</span>
        </button>
        <button onclick="app.switchTab('inventory')" id="nav-inventory" class="nav-btn flex flex-col items-center gap-1 py-2 w-1/4 text-gray-400">
            <i class="fas fa-boxes text-xl mb-0.5"></i>
            <span>åº«å­˜</span>
        </button>
        <button onclick="app.switchTab('history')" id="nav-history" class="nav-btn flex flex-col items-center gap-1 py-2 w-1/4 text-gray-400">
            <i class="fas fa-history text-xl mb-0.5"></i>
            <span>ç´€éŒ„</span>
        </button>
        <button onclick="app.switchTab('admin')" id="nav-admin" class="nav-btn flex flex-col items-center gap-1 py-2 w-1/4 text-gray-400">
            <i class="fas fa-cog text-xl mb-0.5"></i>
            <span>ç®¡ç†</span>
        </button>
    </div>

    <!-- å¼•å…¥ Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, deleteDoc, setDoc, serverTimestamp, orderBy, query, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ============================================================
        // ğŸ” ã€è«‹åœ¨é€™è£¡è¨­å®šå¯†ç¢¼èˆ‡é‡‘é‘°ã€‘
        // ============================================================
        
        // 1. ç™»å…¥å¯†ç¢¼ (å¯è‡ªè¡Œä¿®æ”¹)
        const APP_PASSWORD = "2169"; 

        // 2. Firebase é‡‘é‘° (è«‹å°‡æ‚¨çš„ Config è²¼åœ¨ä¸‹æ–¹çš„å¤§æ‹¬è™Ÿå…§)
        const firebaseConfig = {   
                apiKey: "AIzaSyBXMjjqMz6JVkyACvndahKeKTGHRmeVZ8Q",
                authDomain: "mystockapp-b9c09.firebaseapp.com",
                projectId: "mystockapp-b9c09",
                storageBucket: "mystockapp-b9c09.firebasestorage.app",
                messagingSenderId: "689745750650",
                appId: "1:689745750650:web:aefb53067629476bcda9c3",
                measurementId: "G-4YHP7NFQ73"};
        
        // ============================================================

        // --- App Logic ---
        const app = {
            db: null,
            state: {
                activeTab: 'shopping',
                inventory: [],
                logs: [],
                lastStocktake: null,
                searchTerm: '',
                selectedCategory: 'å…¨éƒ¨',
                editingId: null,
                editForm: {},
                showStats: false,
                statsData: [],
                statsFilter: { start: '', end: '', type: 'all', value: '' }
            },

            // 1. ç™»å…¥æª¢æŸ¥
            checkLogin: () => {
                const input = document.getElementById('login-pass');
                if (input.value === APP_PASSWORD) {
                    document.getElementById('login-screen').classList.add('hidden');
                    sessionStorage.setItem('isLoggedIn', 'true');
                    app.initFirebase(); // ç™»å…¥æˆåŠŸç›´æ¥é€£ç·š
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                    input.value = '';
                }
            },

            // 2. åˆå§‹åŒ– Firebase (ä½¿ç”¨ä¸Šæ–¹ç¡¬ç·¨ç¢¼çš„ firebaseConfig)
            initFirebase: () => {
                // æª¢æŸ¥æ˜¯å¦å·²å¡«å…¥ Config
                if (!firebaseConfig.apiKey) {
                    document.getElementById('loading-screen').innerHTML = `
                        <div class="p-8 text-center w-full">
                            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                            <h2 class="text-xl font-bold mb-2">å°šæœªè¨­å®šè³‡æ–™åº«</h2>
                            <p class="text-sm text-gray-600 mb-4">è«‹ä½¿ç”¨è¨˜äº‹æœ¬é–‹å•Ÿæ­¤ HTML æª”æ¡ˆ<br>ä¸¦åœ¨ç¬¬ 135 è¡Œé™„è¿‘è²¼ä¸Šæ‚¨çš„ Firebase Configã€‚</p>
                            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">é‡æ–°æ•´ç†</button>
                        </div>
                    `;
                    document.getElementById('loading-screen').classList.remove('hidden');
                    throw new Error("No Config");
                }

                document.getElementById('loading-screen').classList.remove('hidden');
                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    app.db = getFirestore(firebaseApp);
                    app.startListeners();
                } catch (e) {
                    alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥é‡‘é‘°æ˜¯å¦æ­£ç¢ºã€‚\n" + e.message);
                    document.getElementById('loading-screen').classList.add('hidden');
                }
            },

            startListeners: () => {
                const db = app.db;
                // ç›£è½åº«å­˜
                onSnapshot(query(collection(db, 'inventory_items')), (snapshot) => {
                    const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    items.sort((a, b) => (a.category || '').localeCompare(b.category || '') || (a.name || '').localeCompare(b.name || ''));
                    app.state.inventory = items;
                    app.checkLoadComplete();
                    app.render();
                });

                // ç›£è½ç´€éŒ„
                onSnapshot(query(collection(db, 'inventory_logs'), orderBy("timestamp", "desc"), limit(50)), (snapshot) => {
                    app.state.logs = snapshot.docs.map(d => {
                        const data = d.data();
                        let timeStr = '';
                        if (data.timestamp) timeStr = data.timestamp.toDate().toLocaleString('zh-TW', { hour12: false, month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit' });
                        return { id: d.id, ...data, timeStr };
                    });
                    app.checkLoadComplete();
                    app.render();
                });

                // ç›£è½ç›¤é»
                onSnapshot(doc(db, 'settings', 'general'), (docSnap) => {
                    if (docSnap.exists() && docSnap.data().lastStocktake) {
                        app.state.lastStocktake = docSnap.data().lastStocktake.toDate().toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                    }
                    app.render();
                });
            },

            checkLoadComplete: () => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            },

            // --- Actions ---
            switchTab: (tab) => {
                app.state.activeTab = tab;
                app.render();
            },

            updateStock: async (id, changeAmount, reason = 'æ‰‹å‹•èª¿æ•´') => {
                const item = app.state.inventory.find(i => i.id === id);
                if (!item) return;
                const newStock = Math.max(0, (item.stock || 0) + parseInt(changeAmount));
                try {
                    await updateDoc(doc(app.db, 'inventory_items', id), { stock: newStock });
                    await addDoc(collection(app.db, 'inventory_logs'), {
                        itemId: id, itemName: item.name, category: item.category,
                        change: parseInt(changeAmount), finalStock: newStock, reason: reason, timestamp: serverTimestamp()
                    });
                    if (changeAmount > 0) app.showNotification(`å·²è£œè²¨: ${item.name} +${changeAmount}`);
                } catch (e) { alert("æ›´æ–°å¤±æ•—"); }
            },

            buyCustomQty: (id) => {
                const val = document.getElementById(`qty-${id}`).value;
                if(val > 0) app.updateStock(id, val, 'æ¡è³¼è£œè²¨');
            },

            updateStocktakeDate: async () => {
                if(!confirm("ç¢ºå®šæ›´æ–°ç›¤é»æ—¥æœŸï¼Ÿ")) return;
                await setDoc(doc(app.db, 'settings', 'general'), { lastStocktake: serverTimestamp() }, { merge: true });
                app.showNotification("ç›¤é»å®Œæˆï¼");
            },

            deleteLog: async (id) => {
                if(confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) await deleteDoc(doc(app.db, 'inventory_logs', id));
            },

            // --- Stats ---
            openStats: async () => {
                const today = new Date();
                const lastMonth = new Date(); lastMonth.setDate(today.getDate() - 30);
                app.state.statsFilter = { start: lastMonth.toISOString().split('T')[0], end: today.toISOString().split('T')[0], type: 'all', value: '' };
                app.state.showStats = true; app.state.statsData = null;
                app.render();
                app.runStatsQuery();
            },
            
            runStatsQuery: async () => {
                try {
                    app.state.statsData = null; app.render();
                    const snapshot = await getDocs(query(collection(app.db, 'inventory_logs'), orderBy("timestamp", "desc"), limit(1000)));
                    const filter = app.state.statsFilter;
                    const start = new Date(filter.start); start.setHours(0,0,0,0);
                    const end = new Date(filter.end); end.setHours(23,59,59,999);
                    const statsMap = {};

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if(!data.timestamp) return;
                        const d = data.timestamp.toDate();
                        if(d < start || d > end) return;
                        if(filter.type === 'category') {
                            let cat = data.category || app.state.inventory.find(i => i.name === data.itemName)?.category;
                            if(cat !== filter.value) return;
                        } else if(filter.type === 'item' && data.itemName !== filter.value) return;

                        const key = `${d.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'})}_${data.itemName}`;
                        if(!statsMap[key]) statsMap[key] = { date: key.split('_')[0], name: data.itemName, in: 0, out: 0, ts: d.getTime() };
                        if(data.change > 0) statsMap[key].in += data.change; else statsMap[key].out += Math.abs(data.change);
                    });
                    app.state.statsData = Object.values(statsMap).sort((a,b) => b.ts - a.ts);
                    app.render();
                } catch(e) { alert("çµ±è¨ˆå¤±æ•—"); }
            },

            updateStatsType: (type) => {
                app.state.statsFilter.type = type;
                if(type === 'category') {
                    const cats = [...new Set(app.state.inventory.map(i => i.category))];
                    app.state.statsFilter.value = cats[0] || '';
                } else if(type === 'item') {
                    const items = app.state.inventory.map(i => i.name).sort();
                    app.state.statsFilter.value = items[0] || '';
                }
                app.render();
            },

            // --- Admin CRUD ---
            openEditModal: (itemStr) => {
                app.state.editingId = itemStr ? JSON.parse(decodeURIComponent(itemStr)).id : 'NEW';
                app.state.editForm = itemStr ? JSON.parse(decodeURIComponent(itemStr)) : { category: 'æ—¥å¸¸', name: '', stock: 0, safety: 1, unit: 'å€‹' };
                app.render();
            },
            saveEdit: async () => {
                const form = app.state.editForm;
                if(!form.name) return alert("è«‹è¼¸å…¥åç¨±");
                const data = { category: form.category, name: form.name, stock: parseInt(form.stock), safety: parseInt(form.safety), unit: form.unit };
                try {
                    if(app.state.editingId === 'NEW') await addDoc(collection(app.db, 'inventory_items'), data);
                    else await updateDoc(doc(app.db, 'inventory_items', app.state.editingId), data);
                    app.state.editingId = null; app.render(); app.showNotification("å„²å­˜æˆåŠŸ");
                } catch(e) { alert("å„²å­˜å¤±æ•—"); }
            },
            deleteItem: async (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(app.db, 'inventory_items', id));
            },

            showNotification: (msg) => {
                const el = document.createElement('div');
                el.className = 'bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm mb-2 animate-fade-in-up flex items-center gap-2';
                el.innerHTML = `<i class="fas fa-check-circle text-green-400"></i> ${msg}`;
                document.getElementById('notification-area').appendChild(el);
                setTimeout(() => el.remove(), 2500);
            },

            render: () => {
                const state = app.state;
                const container = document.getElementById('main-content');
                const navBtns = document.querySelectorAll('.nav-btn');
                
                // Badge & Nav
                const toBuyCount = state.inventory.filter(i => (i.stock||0) <= (i.safety||0)).length;
                const badge = document.getElementById('badge-count');
                if(toBuyCount>0) { badge.innerText=toBuyCount; badge.classList.remove('hidden'); } else badge.classList.add('hidden');
                
                navBtns.forEach(b => b.className = b.className.replace('text-blue-600', 'text-gray-400'));
                document.getElementById(`nav-${state.activeTab}`).className = document.getElementById(`nav-${state.activeTab}`).className.replace('text-gray-400', 'text-blue-600');

                let html = '';

                // 1. å¾…è²·æ¸…å–®
                if (state.activeTab === 'shopping') {
                    const toBuy = state.inventory.filter(i => (i.stock||0) <= (i.safety||0));
                    html += `<div class="bg-blue-600 text-white p-4 rounded-xl shadow-md mb-4 flex justify-between items-center"><div><h2 class="font-bold text-lg">å¾…è²·æ¸…å–®</h2><p class="text-xs text-blue-100">å¯ç·¨è¼¯æ•¸é‡</p></div><i class="fas fa-shopping-basket text-2xl opacity-20"></i></div><div class="grid gap-3">`;
                    if(toBuy.length === 0) html += `<div class="text-center py-12 text-gray-400"><i class="fas fa-check-circle text-4xl mb-2 text-green-300"></i><br>åº«å­˜å……è¶³</div>`;
                    toBuy.forEach(item => {
                        const diff = (item.safety||0) - (item.stock||0) + 1;
                        html += `<div class="bg-white p-3 rounded-xl shadow-sm flex flex-col gap-2"><div class="flex justify-between items-start"><div><div class="font-bold text-gray-800">${item.name}</div><div class="text-xs text-red-500 font-bold mt-1">ç¼º ${(item.safety||0)-(item.stock||0)}</div></div><div class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">${item.category}</div></div><div class="flex items-center gap-2 mt-1 pt-2 border-t border-gray-100"><div class="flex items-center bg-gray-50 rounded-lg px-2 border border-gray-200"><span class="text-xs text-gray-400 mr-2">è²·</span><input type="number" id="qty-${item.id}" value="${diff}" class="w-12 bg-transparent text-center font-bold py-1.5 text-sm outline-none" onclick="this.select()"><span class="text-xs text-gray-400 ml-1">${item.unit}</span></div><button onclick="app.buyCustomQty('${item.id}')" class="flex-1 bg-green-500 text-white py-2 rounded-lg text-sm font-bold shadow-sm active:scale-95 flex justify-center gap-2"><i class="fas fa-cart-plus"></i> å…¥åº«</button></div></div>`;
                    });
                    html += `</div>`;
                }
                // 2. åº«å­˜
                else if (state.activeTab === 'inventory') {
                    const cats = ['å…¨éƒ¨', ...new Set(state.inventory.map(i => i.category))];
                    const filtered = state.inventory.filter(i => (i.name.toLowerCase().includes(state.searchTerm.toLowerCase())) && (state.selectedCategory === 'å…¨éƒ¨' || i.category === state.selectedCategory));
                    html += `<div class="px-1 mb-2 flex justify-between items-end"><div class="text-gray-500 text-sm font-bold">æœ€å¾Œç›¤é»ï¼š<span class="text-blue-600 text-lg">${state.lastStocktake || "--/--"}</span></div></div>`;
                    html += `<div class="sticky top-0 bg-gray-100 z-10 pb-2 space-y-2"><div class="relative"><i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="text" placeholder="æœå°‹..." value="${state.searchTerm}" oninput="app.state.searchTerm=this.value; app.render()" class="w-full pl-10 pr-4 py-2 bg-white rounded-xl shadow-sm border-none text-sm"></div><div class="flex gap-2 overflow-x-auto no-scrollbar">${cats.map(c => `<button onclick="app.state.selectedCategory='${c}'; app.render()" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all ${state.selectedCategory === c ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 shadow-sm'}">${c}</button>`).join('')}</div></div>`;
                    html += `<div class="grid gap-3 pb-4">`;
                    filtered.forEach(item => {
                        const isLow = (item.stock||0) <= (item.safety||0);
                        html += `<div class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${isLow ? 'border-red-500' : 'border-green-500'} flex justify-between items-center"><div><div class="flex items-center gap-2 mb-1"><span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded font-bold">${item.category}</span>${isLow ? '<span class="text-[10px] bg-red-100 text-red-500 px-1.5 py-0.5 rounded font-bold"><i class="fas fa-exclamation"></i> è£œè²¨</span>' : ''}</div><h3 class="font-bold text-gray-800">${item.name}</h3><div class="text-xs text-gray-400 mt-0.5">å®‰å…¨: ${item.safety} ${item.unit}</div></div><div class="flex items-center gap-3 bg-gray-50 p-1.5 rounded-lg"><button onclick="app.updateStock('${item.id}', -1)" class="w-8 h-8 flex items-center justify-center bg-white shadow-sm rounded-lg active:scale-90"><i class="fas fa-minus text-gray-600 text-xs"></i></button><span class="w-6 text-center font-bold ${isLow ? 'text-red-600' : 'text-gray-800'}">${item.stock}</span><button onclick="app.updateStock('${item.id}', 1)" class="w-8 h-8 flex items-center justify-center bg-blue-600 shadow-md rounded-lg active:scale-90"><i class="fas fa-plus text-white text-xs"></i></button></div></div>`;
                    });
                    html += `</div><div class="mt-6 mb-4"><button onclick="app.updateStocktakeDate()" class="w-full bg-blue-100 text-blue-600 py-4 rounded-xl font-bold shadow-sm active:scale-95 flex justify-center items-center gap-2 border border-blue-200"><i class="fas fa-check-double text-xl"></i><span>ç¢ºèªç›¤é»å®Œæˆ</span></button></div>`;
                }
                // 3. ç´€éŒ„
                else if (state.activeTab === 'history') {
                    html += `<div class="bg-white rounded-xl shadow-sm overflow-hidden divide-y divide-gray-100">`;
                    state.logs.forEach(log => {
                        html += `<div class="p-3 flex justify-between items-center group"><div class="flex items-center gap-3 flex-1"><div class="w-8 h-8 rounded-full flex items-center justify-center ${log.change > 0 ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}"><i class="fas ${log.change > 0 ? 'fa-arrow-down transform rotate-180' : 'fa-arrow-down'} text-xs"></i></div><div><div class="font-bold text-sm text-gray-800">${log.itemName}</div><div class="text-[10px] text-gray-400">${log.timeStr}</div></div></div><div class="text-right flex items-center gap-4"><div><div class="font-bold ${log.change > 0 ? 'text-green-600' : 'text-orange-600'}">${log.change > 0 ? '+' : ''}${log.change}</div><div class="text-[10px] text-gray-400">é¤˜: ${log.finalStock}</div></div><button onclick="app.deleteLog('${log.id}')" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 rounded-full"><i class="fas fa-times"></i></button></div></div>`;
                    });
                    html += `</div>`;
                }
                // 4. ç®¡ç†
                else if (state.activeTab === 'admin') {
                    html += `<div class="grid grid-cols-2 gap-3 mb-4"><div class="bg-purple-600 text-white p-4 rounded-xl shadow-md flex flex-col justify-between"><div><h2 class="font-bold text-lg">å•†å“ç®¡ç†</h2></div><button onclick="app.openEditModal()" class="mt-2 bg-white text-purple-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm active:scale-95 self-start"><i class="fas fa-plus"></i> æ–°å¢</button></div><button onclick="app.openStats()" class="bg-indigo-500 text-white p-4 rounded-xl shadow-md flex flex-col justify-between items-start active:scale-95"><div><h2 class="font-bold text-lg">çµ±è¨ˆå ±è¡¨</h2></div><div class="mt-2 text-2xl opacity-50"><i class="fas fa-chart-line"></i></div></button></div><div class="bg-white rounded-xl shadow-sm overflow-hidden divide-y divide-gray-100">`;
                    state.inventory.forEach(item => {
                        const str = encodeURIComponent(JSON.stringify(item));
                        html += `<div class="p-3 flex justify-between items-center"><div><span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded mr-1">${item.category}</span><span class="text-sm font-bold text-gray-800">${item.name}</span></div><div class="flex gap-2"><button onclick="app.openEditModal('${str}')" class="p-1.5 text-blue-500 bg-blue-50 rounded hover:bg-blue-100"><i class="fas fa-edit text-xs"></i></button><button onclick="app.deleteItem('${item.id}')" class="p-1.5 text-red-500 bg-red-50 rounded hover:bg-red-100"><i class="fas fa-trash text-xs"></i></button></div></div>`;
                    });
                    html += `</div>`;

                    // çµ±è¨ˆ Modal
                    if(state.showStats) {
                        let selHTML = '';
                        if(state.statsFilter.type === 'category') {
                            const cats = [...new Set(state.inventory.map(i=>i.category))];
                            selHTML = `<select onchange="app.state.statsFilter.value=this.value; app.render()" class="flex-1 border rounded px-2 py-1 bg-white text-xs">${cats.map(c=>`<option value="${c}" ${state.statsFilter.value===c?'selected':''}>${c}</option>`).join('')}</select>`;
                        } else if(state.statsFilter.type === 'item') {
                            const items = state.inventory.map(i=>i.name).sort();
                            selHTML = `<select onchange="app.state.statsFilter.value=this.value; app.render()" class="flex-1 border rounded px-2 py-1 bg-white text-xs">${items.map(n=>`<option value="${n}" ${state.statsFilter.value===n?'selected':''}>${n}</option>`).join('')}</select>`;
                        } else { selHTML = `<select disabled class="flex-1 border rounded px-2 py-1 bg-gray-100 text-xs"><option>å…¨éƒ¨</option></select>`; }

                        html += `<div class="modal-overlay"><div class="modal-content animate-fade-in-up"><div class="p-4 border-b border-gray-100 flex justify-between items-center flex-none"><h3 class="font-bold text-lg">ğŸ“Š çµ±è¨ˆå ±è¡¨</h3><button onclick="app.state.showStats=false; app.render()" class="text-gray-400"><i class="fas fa-times"></i></button></div><div class="p-3 bg-gray-50 border-b border-gray-100 space-y-2 text-sm"><div class="flex gap-2"><input type="date" value="${state.statsFilter.start}" onchange="app.state.statsFilter.start=this.value" class="flex-1 border rounded px-2 py-1 text-xs"><span class="text-gray-400 self-center">~</span><input type="date" value="${state.statsFilter.end}" onchange="app.state.statsFilter.end=this.value" class="flex-1 border rounded px-2 py-1 text-xs"></div><div class="flex gap-2"><select onchange="app.updateStatsType(this.value)" class="w-1/3 border rounded px-2 py-1 bg-white text-xs"><option value="all" ${state.statsFilter.type==='all'?'selected':''}>å…¨éƒ¨</option><option value="category" ${state.statsFilter.type==='category'?'selected':''}>åˆ†é¡</option><option value="item" ${state.statsFilter.type==='item'?'selected':''}>å“é …</option></select>${selHTML}<button onclick="app.runStatsQuery()" class="bg-indigo-500 text-white px-3 py-1 rounded font-bold text-xs">æŸ¥è©¢</button></div></div><div class="p-4 overflow-y-auto flex-1">${!state.statsData ? '<div class="text-center py-10"><i class="fas fa-circle-notch fa-spin text-blue-500"></i></div>' : state.statsData.length===0 ? '<div class="text-center py-10 text-gray-400">ç„¡è³‡æ–™</div>' : `<table class="w-full text-sm"><thead><tr class="text-gray-400 border-b"><th class="text-left pb-2 font-normal">æ—¥æœŸ</th><th class="text-left pb-2 font-normal">å“å</th><th class="text-right pb-2 font-normal">ç•°å‹•</th></tr></thead><tbody class="divide-y divide-gray-50">${state.statsData.map(d=>`<tr><td class="py-2 text-gray-400 text-xs">${d.date}</td><td class="py-2 font-bold text-gray-700">${d.name}${d.in>0&&d.out>0?`<div class="text-[10px] text-gray-400">é€²${d.in}/å‡º${d.out}</div>`:''}</td><td class="py-2 text-right">${d.in>0?`<span class="text-green-600">+${d.in}</span>`:''}${d.in>0&&d.out>0?' / ':''}${d.out>0?`<span class="text-orange-600">-${d.out}</span>`:''}</td></tr>`).join('')}</tbody></table>`}</div></div></div>`;
                    }

                    // ç·¨è¼¯ Modal
                    if(state.editingId) {
                        html += `<div class="modal-overlay"><div class="modal-content animate-fade-in-up"><div class="p-4 border-b border-gray-100 flex justify-between items-center flex-none"><h3 class="font-bold text-lg">${state.editingId==='NEW'?'æ–°å¢':'ç·¨è¼¯'}</h3><button onclick="app.state.editingId=null; app.render()" class="text-gray-400"><i class="fas fa-times"></i></button></div><div class="p-5 overflow-y-auto flex-1"><div class="space-y-4"><div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">åˆ†é¡</label><input type="text" value="${state.editForm.category||''}" oninput="app.state.editForm.category=this.value" class="w-full bg-gray-100 rounded-lg p-2.5 text-sm"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å–®ä½</label><input type="text" value="${state.editForm.unit||''}" oninput="app.state.editForm.unit=this.value" class="w-full bg-gray-100 rounded-lg p-2.5 text-sm"></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å“å</label><input type="text" value="${state.editForm.name||''}" oninput="app.state.editForm.name=this.value" class="w-full bg-gray-100 rounded-lg p-2.5 text-sm"></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">åº«å­˜</label><input type="number" value="${state.editForm.stock}" oninput="app.state.editForm.stock=this.value" class="w-full bg-gray-100 rounded-lg p-2.5 text-sm"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å®‰å…¨</label><input type="number" value="${state.editForm.safety}" oninput="app.state.editForm.safety=this.value" class="w-full bg-gray-100 rounded-lg p-2.5 text-sm"></div></div></div></div><div class="p-4 border-t border-gray-100 flex gap-2 flex-none bg-white rounded-b-xl"><button onclick="app.state.editingId=null; app.render()" class="flex-1 py-3 text-gray-500 bg-gray-100 rounded-lg font-bold">å–æ¶ˆ</button><button onclick="app.saveEdit()" class="flex-1 py-3 text-white bg-purple-600 rounded-lg font-bold shadow-md">å„²å­˜</button></div></div></div>`;
                    }
                }

                container.innerHTML = html;
            }
        };

        // æŒ‰ä¸‹ Enter ç™»å…¥
        document.getElementById('login-pass').addEventListener('keypress', (e) => { if (e.key === 'Enter') app.checkLogin(); });
        
        // æš´éœ²çµ¦ HTML
        window.app = app;

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ (Session)
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('login-screen').classList.add('hidden');
            app.initFirebase();
        }
    </script>
</body>
</html>